<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>FAKELINE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body>
  <div class="app-wrapper">
    <div class="header">
      <h1>FAKE LINE</h1>
    </div>


    <!-- トーク画面とボタン群 -->
    <div class="chat-container glass">



      <!-- 相手側入力フォーム -->
      <form id="partner-form" class="input-form top-form">
        <input type="text" id="partner-input" placeholder="相手のメッセージを入力..." />
        <input type="file" id="partner-image" accept="image/*" hidden />
        <button type="button" onclick="document.getElementById('user-image').click()">
          <img src="{{ url_for('static', filename='images/Image.png') }}" alt="画像送信" style="width:20px; height:20px;">
        </button>
        <button type="submit">送信</button>
      </form>

      <!-- トーク画面 -->
      <div id="chat-window" class="chat-window"></div>

      <!-- 自分側入力フォーム -->
      <form id="user-form" class="input-form bottom-form">
        <input type="text" id="user-input" placeholder="自分のメッセージを入力..." />
        <input type="file" id="user-image" accept="image/*" hidden />
        <button type="button" onclick="document.getElementById('user-image').click()">
          <img src="{{ url_for('static', filename='images/Image.png') }}" alt="画像送信" style="width:20px; height:20px;">
        </button>
        <button type="submit">送信</button>
      </form>
    </div>

    <!-- サイドボタン -->
    <div class="sidebar">
      <button id="screenshot-btn" style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;">
        <img src="{{ url_for('static', filename='images/ScreenShot.png') }}" 
            alt="スクショ" 
            style="width:24px; height:24px;">
        <span>スクショ</span>
      </button>
      <button id="mode-btn" style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;">
        <img src="{{ url_for('static', filename='images/LightDark.png') }}" 
            alt="モード切替" 
            style="width:24px; height:24px;">
        <span>モード切替</span>
      </button>
      <button id="bg-btn" style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;">
        <img src="{{ url_for('static', filename='images/BackGround.png') }}" 
            alt="背景変更" 
            style="width:24px; height:24px;">
        <span>背景変更</span>
      </button>
    </div>
    <div class="sidebar">
      <button id="delete-last-btn" style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;">
        <img src="{{ url_for('static', filename='images/BackGround.png') }}" 
            alt="直前削除" 
            style="width:24px; height:24px;">
        <span>直前削除</span>
      </button>

      <!-- 友達管理ボタン -->
      <button id="friends-btn" style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;">
        <img src="{{ url_for('static', filename='images/BackGround.png') }}" 
            alt="友達管理" 
            style="width:24px; height:24px;">
        <span>友達管理</span>
      </button>

    </div>
    <div>
      <input type="file" id="bg-file" accept="image/*" hidden />
      <!-- 友だちリスト -->
      友達選択
      <select id="friend-list" class="friend-list">
        {% for filename in friend_files %}
          {% set name = filename.rsplit('.', 1)[0] %}
          <option value="{{ filename }}">{{ name }}</option>
        {% endfor %}
      </select>

      <!-- <select id="friend-list" class="friend-list">
        {% for friend in friends %}
          <option value="{{ friend.icon_filename }}">{{ friend.name }}</option>
        {% endfor %}
      </select> -->


    </div>
  </div>

  <!-- html2canvasでスクショ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    function getTime() {
      const now = new Date();
      return now.getHours().toString().padStart(2,"0") + ":" + now.getMinutes().toString().padStart(2,"0");
    }

    function addMessage(content, sender, isImage=false) {
      const chatWindow = document.getElementById("chat-window");
      const msg = document.createElement("div");
      msg.classList.add("message", sender);

      const bubble = document.createElement("div");
      bubble.classList.add("bubble");

      // メッセージ削除ボタン
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "削除";
      deleteBtn.onclick = () => msg.remove();
      bubble.appendChild(deleteBtn);

      const tail = document.createElement("img");
      tail.classList.add("bubble-tail");
      if (sender === "user") {
        tail.src = "{{ url_for('static', filename='images/you_message_design_pc.png') }}";
      } else {
        tail.src = "{{ url_for('static', filename='images/partner_message_design_pc.png') }}";
      }

      if (sender === "partner") {
        const friendSelect = document.getElementById("friend-list");
        const selectedFriend = friendSelect.value;
        const avatar = document.createElement("img");
        avatar.classList.add("friend-avatar");
        avatar.src = "{{ url_for('static', filename='images/friends/') }}" + selectedFriend;
        msg.appendChild(avatar);
      }
      
      if (isImage) {
        const img = document.createElement("img");
        img.src = content;
        img.classList.add("msg-image");
        bubble.appendChild(img);
      } else {
        bubble.textContent = content;
      }

      const metaBox = document.createElement("div");
      metaBox.classList.add("meta-box");

      if (sender === "user") {
        const read = document.createElement("div");
        read.classList.add("meta-read");
        read.textContent = "既読";
        metaBox.appendChild(read);
      }

      bubble.classList.add("bubble");
      const time = document.createElement("div");
      time.classList.add("meta-time");
      time.textContent = getTime();
      metaBox.appendChild(time);

      msg.appendChild(tail);
      msg.appendChild(bubble);
      msg.appendChild(metaBox);
      chatWindow.appendChild(msg);

      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // 友達管理ページへ遷移
    document.getElementById("friends-btn").addEventListener("click", () => {
      window.location.href = "{{ url_for('main.friends') }}";
    });

    // 直前メッセージ削除
    document.getElementById("delete-last-btn").addEventListener("click", () => {
      const chatWindow = document.getElementById("chat-window");
      if (chatWindow.lastElementChild) {
        chatWindow.removeChild(chatWindow.lastElementChild);
      }
    });


    // 相手テキスト送信
    document.getElementById("partner-form").addEventListener("submit", e => {
      e.preventDefault();
      const input = document.getElementById("partner-input");
      if (input.value.trim()) {
        addMessage(input.value, "partner");
        input.value = "";
      }
    });

    // 自分テキスト送信
    document.getElementById("user-form").addEventListener("submit", e => {
      e.preventDefault();
      const input = document.getElementById("user-input");
      if (input.value.trim()) {
        addMessage(input.value, "user");
        input.value = "";
      }
    });

    // 画像送信
    document.getElementById("partner-image").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => addMessage(ev.target.result, "partner", true);
        reader.readAsDataURL(file);
      }
    });

    document.getElementById("user-image").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => addMessage(ev.target.result, "user", true);
        reader.readAsDataURL(file);
      }
    });

    // スクショ保存（トーク画面のみ）
    document.getElementById("screenshot-btn").addEventListener("click", () => {
      html2canvas(document.querySelector(".chat-window")).then(canvas => {
        const link = document.createElement("a");
        link.download = "chat.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    });

    // モード切替
    document.getElementById("mode-btn").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });

    // 背景変更
    document.getElementById("bg-btn").addEventListener("click", () => {
      document.getElementById("bg-file").click();
    });
    document.getElementById("bg-file").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          const chatContainer = document.querySelector(".chat-container");
          chatContainer.style.backgroundImage = `url(${ev.target.result})`;
          chatContainer.style.backgroundRepeat = "no-repeat";
          chatContainer.style.backgroundPosition = "center";
          chatContainer.style.backgroundSize = "auto 100%"; // ← 縦をフィット
        };
        reader.readAsDataURL(file);
      }
    });

  </script>
</body>
</html>
